<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Memory System - Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0000 100%);
            color: #fca5a5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px;
            background: rgba(127, 29, 29, 0.2);
            border: 2px solid #7f1d1d;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        h1 {
            color: #dc2626;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tier-badge {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(90deg, #7f1d1d, #991b1b);
            border: 2px solid #dc2626;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            margin-top: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #7f1d1d;
            border-radius: 12px;
            padding: 20px;
        }

        .panel h2 {
            color: #dc2626;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .chat-container {
            grid-column: 1 / -1;
        }

        .messages {
            height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #7f1d1d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .message.user {
            background: rgba(220, 38, 38, 0.2);
            border-left: 3px solid #dc2626;
        }

        .message.assistant {
            background: rgba(16, 185, 129, 0.2);
            border-left: 3px solid #10b981;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .message-content {
            color: #ffffff;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        input[type="text"], textarea {
            flex: 1;
            padding: 12px;
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid #7f1d1d;
            border-radius: 8px;
            color: #fca5a5;
            font-size: 14px;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #dc2626;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(90deg, #7f1d1d, #991b1b);
            border: 2px solid #dc2626;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: linear-gradient(90deg, #991b1b, #b91c1c);
            border-color: #ef4444;
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: rgba(127, 29, 29, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #dc2626;
        }

        .stat-label {
            font-size: 0.9em;
            margin-top: 5px;
            opacity: 0.8;
        }

        .history-item {
            padding: 8px;
            margin-bottom: 8px;
            background: rgba(127, 29, 29, 0.1);
            border-left: 3px solid #7f1d1d;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .emotion-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .emotion-positive {
            background: rgba(16, 185, 129, 0.3);
            border: 1px solid #10b981;
        }

        .emotion-neutral {
            background: rgba(156, 163, 175, 0.3);
            border: 1px solid #9ca3af;
        }

        .emotion-negative {
            background: rgba(239, 68, 68, 0.3);
            border: 1px solid #ef4444;
        }

        .log {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèõÔ∏è Aurora Memory System</h1>
            <p>Phase 2: Per-User JSONL Memory Integration Demo</p>
            <div class="tier-badge" id="tierBadge">Tier 1: Wanderer</div>
        </header>

        <div class="grid">
            <div class="panel">
                <h2>üîë Session Control</h2>
                <div class="input-group" style="flex-direction: column; gap: 10px;">
                    <input type="text" id="threadIdInput" placeholder="Thread ID (auto-generated)">
                    <select id="tierSelect" style="padding: 12px; background: rgba(220, 38, 38, 0.1); border: 2px solid #7f1d1d; border-radius: 8px; color: #fca5a5;">
                        <option value="1">Tier 1: Wanderer (No memory)</option>
                        <option value="2">Tier 2: Initiate (10 messages)</option>
                        <option value="3" selected>Tier 3: Acolyte (25 messages)</option>
                        <option value="4">Tier 4: Keeper (50 messages + cross-site)</option>
                        <option value="5">Tier 5: Sentinel (100 messages)</option>
                        <option value="6">Tier 6: Archon (500 messages)</option>
                        <option value="7">Tier 7: Inner Sanctum (Unlimited)</option>
                    </select>
                    <button onclick="initTestSession()">üéÆ Start Test Session</button>
                    <button onclick="loadHistory()">üìú Load History</button>
                </div>
                <div class="log" id="sessionLog"></div>
            </div>

            <div class="panel">
                <h2>üìä Memory Stats</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="eventCount">0</div>
                        <div class="stat-label">Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="fileSize">0 KB</div>
                        <div class="stat-label">Size</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="tierLimit">0</div>
                        <div class="stat-label">Limit</div>
                    </div>
                </div>
                <button onclick="refreshStats()" style="width: 100%; margin-top: 15px;">üîÑ Refresh Stats</button>
            </div>

            <div class="panel chat-container">
                <h2>üí¨ Chat Interface</h2>
                <div class="messages" id="messages"></div>
                <div class="input-group">
                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleEnter(event)">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>

            <div class="panel">
                <h2>üé≠ Emotion Tracking</h2>
                <div id="emotionDisplay">
                    <p>No emotional data yet. Send some messages!</p>
                </div>
                <button onclick="analyzeEmotions()" style="width: 100%; margin-top: 15px;">üîç Analyze Emotions</button>
            </div>

            <div class="panel">
                <h2>üåê Cross-Site Summary</h2>
                <div id="crossSiteDisplay">
                    <p>Available for Tier 4+ (Keeper and above)</p>
                </div>
                <button onclick="getCrossSiteSummary()" style="width: 100%; margin-top: 15px;">üì° Get Summary</button>
            </div>
        </div>
    </div>

    <script src="Aurora/memory_client.js"></script>
    <script>
        // Initialize memory client
        const memoryClient = new AuroraMemoryClient('http://localhost:5000/api');
        let messageCount = 0;

        // Generate random UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Get tier name
        function getTierName(tier) {
            const names = {
                1: 'Wanderer', 2: 'Initiate', 3: 'Acolyte', 4: 'Keeper',
                5: 'Sentinel', 6: 'Archon', 7: 'Inner Sanctum'
            };
            return names[tier] || 'Unknown';
        }

        // Init test session
        async function initTestSession() {
            const tier = parseInt(document.getElementById('tierSelect').value);
            const tierName = getTierName(tier);

            let threadId = document.getElementById('threadIdInput').value;
            if (!threadId) {
                threadId = generateUUID();
                document.getElementById('threadIdInput').value = threadId;
            }

            memoryClient.setSession(threadId, tier, tierName);

            document.getElementById('tierBadge').textContent = `Tier ${tier}: ${tierName}`;

            log(`‚úÖ Session initialized: ${tierName} (Tier ${tier})`);
            log(`üîë Thread ID: ${threadId.substring(0, 8)}...`);

            await refreshStats();
        }

        // Load history
        async function loadHistory() {
            const events = await memoryClient.loadContext();
            log(`üìú Loaded ${events.length} events from memory`);

            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';

            events.reverse().forEach(event => {
                if (event.role === 'user' || event.role === 'assistant') {
                    addMessageToUI(event.role, event.content);
                }
            });
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            if (!memoryClient.isSessionActive()) {
                alert('Please start a test session first!');
                return;
            }

            // Add user message
            addMessageToUI('user', message);
            await memoryClient.storeEvent('user', message, 'demo', {
                primary: 'curiosity',
                intensity: 0.7
            });

            // Simulate AI response
            const responses = [
                "That's an interesting thought! Tell me more.",
                "I understand. How does that make you feel?",
                "Fascinating! I've stored this in your memory.",
                "Great question! Let me think about that.",
                "Your conversation history is growing!"
            ];

            const response = responses[Math.floor(Math.random() * responses.length)];

            setTimeout(async () => {
                addMessageToUI('assistant', response);
                await memoryClient.storeEvent('assistant', response, 'demo', {
                    primary: 'joy',
                    intensity: 0.8
                });

                input.value = '';
                await refreshStats();
            }, 500);
        }

        // Handle enter key
        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Add message to UI
        function addMessageToUI(role, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-header">${role === 'user' ? 'You' : 'Aurora AI'}</div>
                <div class="message-content">${content}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Refresh stats
        async function refreshStats() {
            if (!memoryClient.isSessionActive()) return;

            const stats = await memoryClient.getMemoryStats();

            if (stats) {
                document.getElementById('eventCount').textContent = stats.event_count;
                document.getElementById('fileSize').textContent = (stats.file_size_bytes / 1024).toFixed(2) + ' KB';
                document.getElementById('tierLimit').textContent =
                    stats.memory_depth_limit === -1 ? '‚àû' : stats.memory_depth_limit;

                log(`üìä Stats updated: ${stats.event_count} events, ${(stats.file_size_bytes / 1024).toFixed(2)} KB`);
            }
        }

        // Analyze emotions
        async function analyzeEmotions() {
            if (!memoryClient.isSessionActive()) {
                alert('Please start a test session first!');
                return;
            }

            const emotions = await memoryClient.getEmotionTrajectory();

            if (emotions && emotions.primary_emotion) {
                const emotionClass = emotions.trend === 'positive' ? 'emotion-positive' :
                                    emotions.trend === 'negative' ? 'emotion-negative' : 'emotion-neutral';

                document.getElementById('emotionDisplay').innerHTML = `
                    <div>
                        <strong>Primary Emotion:</strong> ${emotions.primary_emotion}
                    </div>
                    <div>
                        <strong>Intensity:</strong> ${(emotions.intensity_avg * 100).toFixed(0)}%
                    </div>
                    <div class="emotion-indicator ${emotionClass}">
                        Trend: ${emotions.trend.toUpperCase()}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                        Based on ${emotions.event_count} recent events
                    </div>
                `;

                log(`üé≠ Emotion: ${emotions.primary_emotion} (${emotions.trend})`);
            } else {
                document.getElementById('emotionDisplay').innerHTML = '<p>No emotional data yet. Send some messages!</p>';
            }
        }

        // Get cross-site summary
        async function getCrossSiteSummary() {
            if (!memoryClient.isSessionActive()) {
                alert('Please start a test session first!');
                return;
            }

            const summary = await memoryClient.getCrossSiteSummary();

            if (summary) {
                document.getElementById('crossSiteDisplay').innerHTML = `
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #10b981;">
                        <pre style="white-space: pre-wrap; font-size: 0.9em;">${summary}</pre>
                    </div>
                `;
                log('üåê Cross-site summary generated');
            } else {
                document.getElementById('crossSiteDisplay').innerHTML = `
                    <p>Cross-site features are available for Tier 4+ (Keeper and above)</p>
                    <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                        Current tier: ${memoryClient.tierName}
                    </p>
                `;
                log('‚ùå Cross-site not available for current tier');
            }
        }

        // Logging
        function log(message) {
            const logDiv = document.getElementById('sessionLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Page load
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Aurora Memory System Demo loaded');
            log('üí° Click "Start Test Session" to begin');
        });
    </script>
</body>
</html>
