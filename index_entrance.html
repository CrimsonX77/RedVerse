<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The RedVerse — Enter the Church</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════════════
   REDVERSE — CHURCH ENTRANCE
   Landing page with animated video doors
   ═══════════════════════════════════════════════════════════════ */
:root {
  --crimson: #c41230;
  --crimson-dark: #8b0a20;
  --crimson-glow: #ff1a3d;
  --gold: #d4a846;
  --gold-dim: #a8843a;
  --silver: #b8c0cc;
  --silver-dim: #6b7280;
  --black: #0a0a0c;
  --text-primary: #e8e0d8;
  --text-secondary: #9b8e82;
  --font-display: 'Cinzel', serif;
  --font-body: 'Crimson Pro', serif;
  --font-mono: 'JetBrains Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #000;
  font-family: var(--font-body);
}

/* ═══════════════════════════════════════════════════════════════
   PHASE 1: THE CHURCH DOORS (Video Landing)
   ═══════════════════════════════════════════════════════════════ */
#churchEntrance {
  position: fixed;
  inset: 0;
  z-index: 100;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: #000;
  cursor: default;
  transition: opacity 1.2s ease;
}

#churchEntrance.fading {
  opacity: 0;
  pointer-events: none;
}

#churchEntrance.hidden {
  display: none;
}

/* Video container — fills viewport, maintains aspect */
.video-container {
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.video-container video {
  min-width: 100%;
  min-height: 100%;
  width: auto;
  height: auto;
  object-fit: cover;
}

/* Vignette overlay for cinematic framing */
.vignette {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.7) 100%);
  pointer-events: none;
  z-index: 2;
}

/* The invisible click zone over the doors */
#doorHitZone {
  position: absolute;
  top: 10%;
  left: 20%;
  width: 60%;
  height: 75%;
  z-index: 10;
  cursor: pointer;
  border: none;
  background: transparent;
  transition: all 0.3s ease;
}

/* Subtle glow indicator on hover */
#doorHitZone:hover ~ .door-glow-overlay {
  opacity: 1;
}

#doorHitZone:hover ~ .door-prompt {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.door-glow-overlay {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 50% 45%, rgba(196, 18, 48, 0.08) 0%, transparent 60%);
  pointer-events: none;
  z-index: 3;
  opacity: 0;
  transition: opacity 0.6s ease;
}

/* "Enter" prompt that appears on hover */
.door-prompt {
  position: absolute;
  bottom: 12%;
  left: 50%;
  transform: translateX(-50%) translateY(8px);
  z-index: 5;
  pointer-events: none;
  opacity: 0;
  transition: all 0.5s ease;
  text-align: center;
}

.door-prompt span {
  font-family: var(--font-display);
  font-size: 0.7rem;
  letter-spacing: 0.4em;
  text-transform: uppercase;
  color: var(--crimson);
  text-shadow: 0 0 20px rgba(196, 18, 48, 0.5);
  display: block;
}

.door-prompt .sub {
  font-family: var(--font-mono);
  font-size: 0.5rem;
  letter-spacing: 0.2em;
  color: var(--silver-dim);
  margin-top: 4px;
  text-shadow: none;
}

/* Title overlay on the entrance */
.entrance-title {
  position: absolute;
  top: 5%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 5;
  text-align: center;
  pointer-events: none;
}

.entrance-title h1 {
  font-family: var(--font-display);
  font-weight: 900;
  font-size: clamp(1.5rem, 4vw, 3rem);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--crimson);
  text-shadow: 0 0 40px rgba(196, 18, 48, 0.3), 0 2px 20px rgba(0,0,0,0.8);
  opacity: 0;
  animation: titleReveal 2s ease 1s forwards;
}

.entrance-title p {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.35em;
  text-transform: uppercase;
  color: var(--gold-dim);
  text-shadow: 0 1px 10px rgba(0,0,0,0.8);
  margin-top: 6px;
  opacity: 0;
  animation: titleReveal 2s ease 1.8s forwards;
}

@keyframes titleReveal {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 0.85; transform: translateY(0); }
}

/* ═══════════════════════════════════════════════════════════════
   BGM PLAYER CONTROLS
   ═══════════════════════════════════════════════════════════════ */
.bgm-player {
  position: fixed;
  bottom: 16px;
  right: 16px;
  z-index: 200;
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(10, 10, 12, 0.7);
  border: 1px solid rgba(196, 18, 48, 0.25);
  padding: 8px 12px;
  border-radius: 6px;
  backdrop-filter: blur(8px);
  transition: all 0.3s ease;
}

.bgm-player:hover {
  border-color: var(--crimson);
  background: rgba(196, 18, 48, 0.1);
}

.bgm-btn {
  width: 28px;
  height: 28px;
  background: transparent;
  border: 1px solid rgba(196, 18, 48, 0.4);
  color: var(--crimson);
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  border-radius: 3px;
}

.bgm-btn:hover {
  border-color: var(--crimson);
  background: rgba(196, 18, 48, 0.15);
  transform: scale(1.05);
}

.bgm-btn.bgm-play {
  width: 32px;
  height: 32px;
  font-size: 14px;
  background: rgba(196, 18, 48, 0.05);
}

.bgm-btn.muted {
  color: var(--silver-dim);
  border-color: rgba(255, 255, 255, 0.06);
}

.bgm-btn.muted:hover {
  border-color: var(--silver-dim);
  background: rgba(255, 255, 255, 0.05);
}

.bgm-info {
  display: none;
  margin-left: 8px;
  padding-left: 8px;
  border-left: 1px solid rgba(196, 18, 48, 0.2);
  max-width: 180px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.bgm-track-name {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--silver-dim);
  letter-spacing: 0.05em;
}

/* Show info on larger screens */
@media (min-width: 768px) {
  .bgm-info {
    display: block;
  }
}

/* ═══════════════════════════════════════════════════════════════
   PHASE 2: THE REDVERSE (Main Site — loaded via iframe or inline)
   ═══════════════════════════════════════════════════════════════ */
#redverseContent {
  position: fixed;
  inset: 0;
  z-index: 1;
  opacity: 0;
  transition: opacity 1.5s ease;
  overflow: auto;
}

#redverseContent.visible {
  opacity: 1;
  z-index: 50;
}

#redverseContent iframe {
  width: 100%;
  height: 100%;
  border: none;
}

/* ═══════════════════════════════════════════════════════════════
   LOADING STATE
   ═══════════════════════════════════════════════════════════════ */
.loading-overlay {
  position: fixed;
  inset: 0;
  z-index: 90;
  background: #000;
  display: none;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  gap: 1rem;
}

.loading-overlay.active {
  display: flex;
}

.loading-overlay .loader {
  width: 40px;
  height: 40px;
  border: 2px solid rgba(196, 18, 48, 0.1);
  border-top: 2px solid var(--crimson);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-overlay p {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.3em;
  color: var(--silver-dim);
}
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════════
     BGM AUDIO PLAYER
     Dynamic playlist from assets/music folder
     ═══════════════════════════════════════════════════════════════ -->
<audio id="bgm" preload="auto"></audio>

<!-- ═══════════════════════════════════════════════════════════════
     BGM PLAYER CONTROLS
     Previous / Play-Pause / Next with song info
     ═══════════════════════════════════════════════════════════════ -->
<div id="bgmPlayer" class="bgm-player">
  <button id="bgmPrev" class="bgm-btn bgm-nav" title="Previous track">◀</button>
  <button id="bgmToggle" class="bgm-btn bgm-play" title="Play BGM">♫</button>
  <button id="bgmNext" class="bgm-btn bgm-nav" title="Next track">▶</button>
  <div class="bgm-info">
    <span id="bgmTrack" class="bgm-track-name">Loading...</span>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════
     PHASE 1: CHURCH ENTRANCE
     ═══════════════════════════════════════════════════════════════ -->
<div id="churchEntrance">
  <!-- Breathing doors video — loops -->
  <div class="video-container" id="breathingContainer">
    <video id="breathingVideo" muted playsinline loop preload="auto">
      <source src="assets/breathing.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Glowing doors video — shown on hover (hidden initially) -->
  <div class="video-container" id="glowingContainer" style="opacity: 0; transition: opacity 0.8s ease;">
    <video id="glowingVideo" muted playsinline loop preload="auto">
      <source src="assets/glowing.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Enter animation — plays on click (hidden initially) -->
  <div class="video-container" id="enterContainer" style="opacity: 0; z-index: 4;">
    <video id="enterVideo" muted playsinline preload="auto">
      <source src="assets/Enter.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Vignette overlay -->
  <div class="vignette"></div>

  <!-- Invisible door click zone -->
  <div id="doorHitZone"></div>

  <!-- Hover glow -->
  <div class="door-glow-overlay"></div>

  <!-- Hover prompt -->
  <div class="door-prompt">
    <span>Enter the Church</span>
    <div class="sub">Break The Seal</div>
  </div>

  <!-- Title -->
  <div class="entrance-title">
    <h1>RedVerse</h1>
    <p>The Canonical Crimson Chronicles</p>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════
     LOADING OVERLAY (Between enter video and site load)
     ═══════════════════════════════════════════════════════════════ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loader"></div>
  <p>The tales await...</p>
</div>

<!-- ═══════════════════════════════════════════════════════════════
     PHASE 2: REDVERSE CONTENT
     ═══════════════════════════════════════════════════════════════ -->
<div id="redverseContent">
  <iframe id="redverseFrame" src="redverse.html"></iframe>
</div>

<!-- ═══════════════════════════════════════════════════════════════
     JAVASCRIPT — State Machine
     ═══════════════════════════════════════════════════════════════ -->
<script>
(function() {
  const entrance      = document.getElementById('churchEntrance');
  const breathingVid  = document.getElementById('breathingVideo');
  const glowingVid    = document.getElementById('glowingVideo');
  const enterVid      = document.getElementById('enterVideo');
  const breathingBox  = document.getElementById('breathingContainer');
  const glowingBox    = document.getElementById('glowingContainer');
  const enterBox      = document.getElementById('enterContainer');
  const doorHit       = document.getElementById('doorHitZone');
  const loading       = document.getElementById('loadingOverlay');
  const content       = document.getElementById('redverseContent');

  let state = 'breathing'; // breathing | glowing | entering | entered

  // ═══ BGM PLAYLIST SETUP ═══
  const bgm = document.getElementById('bgm');
  const bgmBtn = document.getElementById('bgmToggle');
  const bgmPrev = document.getElementById('bgmPrev');
  const bgmNext = document.getElementById('bgmNext');
  const bgmTrackName = document.getElementById('bgmTrack');

  let bgmPlaylist = [];
  let bgmCurrentIndex = 0;
  let bgmStarted = false;
  let bgmMuted = false;
  let bgmLoading = false;

  bgm.volume = 0.35; // ~35% volume — atmospheric

  // Fetch playlist from server
  async function loadPlaylist() {
    try {
      const response = await fetch('/api/music/list');
      if (!response.ok) throw new Error('Failed to fetch playlist');
      const data = await response.json();
      bgmPlaylist = data.files || [];
      
      if (bgmPlaylist.length > 0) {
        loadTrack(0);
        updateTrackDisplay();
      }
    } catch (error) {
      console.warn('Could not load dynamic playlist:', error);
      // Fallback to default track
      bgmPlaylist = ['assets/music/RedShift.mp3'];
      loadTrack(0);
    }
  }

  function loadTrack(index) {
    if (bgmPlaylist.length === 0) return;
    
    bgmCurrentIndex = (index + bgmPlaylist.length) % bgmPlaylist.length;
    const trackPath = bgmPlaylist[bgmCurrentIndex];
    bgm.src = trackPath;
    bgm.load();
    
    if (bgmStarted && !bgmMuted) {
      bgm.play().catch(() => {});
    }
    
    updateTrackDisplay();
  }

  function updateTrackDisplay() {
    if (bgmPlaylist.length === 0) {
      bgmTrackName.textContent = 'No music loaded';
      return;
    }
    
    const trackPath = bgmPlaylist[bgmCurrentIndex];
    const trackName = trackPath.split('/').pop().replace(/\.[^/.]+$/, '');
    bgmTrackName.textContent = `${bgmCurrentIndex + 1}/${bgmPlaylist.length} • ${trackName}`;
  }

  // Auto-advance to next track when current one ends
  bgm.addEventListener('ended', () => {
    loadTrack(bgmCurrentIndex + 1);
  });

  function startBGM() {
    if (!bgmStarted) {
      bgm.play().catch(() => {});
      bgmStarted = true;
    }
  }

  // Play/Pause toggle
  bgmBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (!bgmStarted) {
      startBGM();
      return;
    }
    
    bgmMuted = !bgmMuted;
    if (bgmMuted) {
      bgm.pause();
      bgmBtn.textContent = '♪';
      bgmBtn.classList.add('muted');
      bgmBtn.title = 'Resume BGM';
    } else {
      bgm.play().catch(() => {});
      bgmBtn.textContent = '♫';
      bgmBtn.classList.remove('muted');
      bgmBtn.title = 'Pause BGM';
    }
  });

  // Previous track
  bgmPrev.addEventListener('click', (e) => {
    e.stopPropagation();
    if (bgmPlaylist.length === 0) return;
    loadTrack(bgmCurrentIndex - 1);
    startBGM();
  });

  // Next track
  bgmNext.addEventListener('click', (e) => {
    e.stopPropagation();
    if (bgmPlaylist.length === 0) return;
    loadTrack(bgmCurrentIndex + 1);
    startBGM();
  });

  // Load playlist on startup
  loadPlaylist();

  // ═══ START BREATHING VIDEO ═══
  breathingVid.play().catch(() => {
    // Autoplay may be blocked — we'll start on first interaction
    document.addEventListener('click', function firstClick() {
      breathingVid.play().catch(() => {});
      document.removeEventListener('click', firstClick);
    }, { once: true });
  });

  // Pre-load glowing video
  glowingVid.play().catch(() => {});

  // ═══ HOVER: Breathing → Glowing ═══
  doorHit.addEventListener('mouseenter', () => {
    if (state !== 'breathing') return;
    state = 'glowing';

    // Crossfade to glowing
    glowingBox.style.opacity = '1';
    glowingBox.style.zIndex = '1';

    // Subtle scale on the glow container for punch
    glowingBox.style.transition = 'opacity 0.8s ease';
  });

  doorHit.addEventListener('mouseleave', () => {
    if (state !== 'glowing') return;
    state = 'breathing';

    // Crossfade back to breathing
    glowingBox.style.opacity = '0';
  });

  // ═══ CLICK: Enter the Church ═══
  doorHit.addEventListener('click', () => {
    if (state === 'entering' || state === 'entered') return;
    state = 'entering';

    // Start BGM on first meaningful interaction
    startBGM();

    // Show enter video
    enterBox.style.opacity = '1';
    enterBox.style.zIndex = '5';
    enterVid.currentTime = 0;
    enterVid.play().catch(() => {});

    // Hide the hover elements
    glowingBox.style.opacity = '0';
    doorHit.style.display = 'none';
    document.querySelector('.door-prompt').style.display = 'none';
    document.querySelector('.door-glow-overlay').style.display = 'none';

    // Fade out the title
    document.querySelector('.entrance-title').style.transition = 'opacity 0.8s ease';
    document.querySelector('.entrance-title').style.opacity = '0';

    // When enter video ends, transition to the site
    enterVid.addEventListener('ended', transitionToSite, { once: true });

    // Safety fallback — if video is super long or fails, transition after 12s
    setTimeout(() => {
      if (state === 'entering') transitionToSite();
    }, 12000);
  });

  // ═══ TRANSITION TO MAIN SITE ═══
  function transitionToSite() {
    if (state === 'entered') return;
    state = 'entered';

    // Fade out entrance
    entrance.classList.add('fading');

    // Show loading briefly
    loading.classList.add('active');

    // After entrance fades, reveal content
    setTimeout(() => {
      entrance.classList.add('hidden');
      loading.classList.remove('active');
      content.classList.add('visible');

      // Re-enable scrolling
      document.body.style.overflow = 'auto';
    }, 1400);
  }

  // ═══ ALTERNATIVE: Full single video mode ═══
  // If you prefer using WelcomeToTheRedVerse.mp4 as one continuous piece:
  // Uncomment below and comment out the breathing/glowing/enter logic above
  /*
  const fullVideo = document.createElement('video');
  fullVideo.src = 'assets/WelcomeToTheRedVerse.mp4';
  fullVideo.muted = true;
  fullVideo.playsInline = true;

  doorHit.addEventListener('click', () => {
    startBGM();
    fullVideo.currentTime = 0; // or wherever the "glowing" starts
    fullVideo.play();
    fullVideo.addEventListener('ended', transitionToSite, { once: true });
  });
  */

})();
</script>

</body>
</html>
